version: "3.8"

services:
  ssh-key-generator:
    image: alpine
    volumes:
      - ssh_data:/root/.ssh
    command: >
      /bin/sh -c "
      mkdir -p /root/.ssh;
      if [ ! -f /root/.ssh/id_ed25519 ]; then
        apk add --no-cache openssh;
        ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -q -N '';
        echo 'SSH keys generated.';
        echo 'ServerAliveInterval 60' >> /root/.ssh/config;
        echo 'ServerAliveCountMax 240' >> /root/.ssh/config;
        echo 'StrictHostKeyChecking no' >> /root/.ssh/config;
        chmod 600 /root/.ssh/config;
      else
        echo 'SSH keys already exist.';
      fi;
      echo 'Public SSH key:';
      cat /root/.ssh/id_ed25519.pub;
      chmod 700 /root/.ssh;
      chmod 600 /root/.ssh/id_ed25519;
      chmod 644 /root/.ssh/id_ed25519.pub;
      "

  backup:
    image: mazzolino/restic
    hostname: docker
    restart: unless-stopped
    env_file:
      - $PWD/.env
    volumes:
      - ssh_data:/run/secrets/.ssh:ro
      - /var/lib/docker/volumes:/mnt/volumes
      - $HOME:/mnt/home
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["/sbin/tini", "--", "/bin/sh", "-c", "unset PRUNE_CRON; /entrypoint"]

  prune:
    image: mazzolino/restic
    hostname: docker
    volumes:
      - ssh_data:/run/secrets/.ssh:ro
    env_file:
      - $PWD/.env
    restart: unless-stopped
    entrypoint: ["/sbin/tini", "--", "/bin/sh", "-c", "unset BACKUP_CRON; unset PRE_COMMANDS; unset POST_COMMANDS_EXIT; unset POST_COMMANDS_SUCCESS; /entrypoint"]

volumes:
  ssh_data: